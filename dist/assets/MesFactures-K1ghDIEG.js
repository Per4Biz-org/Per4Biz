import{u as e,a as t,m as r,j as a,s as n,P as i,F as l,B as c,D as s,T as o,E as d,b as u,f,c as m}from"./index-BEajUY_z.js";import{u as p,b as h,r as b}from"./react-vendor-BFlg0-1N.js";import{f as y,e as g,s as _,g as v}from"./utils-vendor-CgmWFHjG.js";import"./supabase-vendor-fbgt7YPZ.js";const x=()=>{const{setMenuItems:x}=e(),{profil:j,loading:S}=t();p();const w=h(),[N,E]=b.useState([]),[F,D]=b.useState([]),[M,$]=b.useState([]),[C,T]=b.useState(!1),[q,A]=b.useState(()=>{const e=localStorage.getItem("facturesFilters");if(e)try{const t=JSON.parse(e);return t.entite="",t}catch(t){return console.error("Erreur lors du parsing des filtres sauvegardés:",t),{entite:"",dateDebut:y(_(v(new Date)),"yyyy-MM-dd"),dateFin:y(g(new Date),"yyyy-MM-dd")}}return{entite:"",dateDebut:y(_(v(new Date)),"yyyy-MM-dd"),dateFin:y(g(new Date),"yyyy-MM-dd")}}),[I,z]=b.useState(!0),[k,O]=b.useState(!1),[P,J]=b.useState([]),[R,U]=b.useState(!1),[H,L]=b.useState(!1),[V,B]=b.useState(void 0),[G,K]=b.useState(null),Q=async()=>{O(!0);try{if(!(null==j?void 0:j.com_contrat_client_id))return E([]),void U(!0);let e=u.from("fin_facture_achat").select("\n          *,\n          entite:id_entite (\n            code,\n            libelle\n          ),\n          tiers:id_tiers (\n            code,\n            nom\n          ),\n          mode_paiement:id_mode_paiement (\n            code,\n            libelle\n          )").eq("com_contrat_client_id",j.com_contrat_client_id);if(q.entite){const t=F.find(e=>e.code===q.entite||e.id===q.entite);t?(console.log(`Filtrage par entité: ${t.code} (ID: ${t.id})`),e=e.eq("id_entite",t.id)):console.warn(`Entité sélectionnée non trouvée dans la liste: ${q.entite}`)}q.dateDebut&&(e=e.gte("date_facture",q.dateDebut)),q.dateFin&&(e=e.lte("date_facture",q.dateFin)),e=e.order("date_facture",{ascending:!1});const{data:t,error:r}=await e;if(r)throw r;const a=t||[];console.log(`${a.length} factures récupérées avec les filtres actuels`),E(a),$(a),U(!0)}catch(e){console.error("Erreur lors de la récupération des factures:",e),W({label:"Erreur lors de la récupération des factures",icon:"AlertTriangle",color:"#ef4444"})}finally{z(!1),O(!1)}};b.useEffect(()=>{x(r),S||((async()=>{try{if(!(null==j?void 0:j.com_contrat_client_id))return void D([]);const{data:e,error:t}=await u.from("com_entite").select("id, code, libelle").eq("com_contrat_client_id",j.com_contrat_client_id).eq("actif",!0).order("libelle");if(t)throw t;D(e||[]),T(!0)}catch(e){console.error("Erreur lors de la récupération des entités:",e)}})(),z(!1))},[x,S,null==j?void 0:j.com_contrat_client_id]),b.useEffect(()=>{var e,t;if(C&&!I&&!k){const a=null==(e=w.state)?void 0:e.fromFactureEdit,n=null==(t=w.state)?void 0:t.entiteId;if(a)if(n){const e=F.find(e=>e.id===n);if(e){const t={...q,entite:e.code};A(t);try{localStorage.setItem("facturesFilters",JSON.stringify(t))}catch(r){console.error("Erreur lors de la sauvegarde des filtres:",r)}setTimeout(()=>{console.log("Recherche automatique après retour d'édition avec entité:",e.code),Q()},100)}}else q.entite&&(console.log("Recherche automatique après retour d'édition avec filtre existant:",q.entite),Q())}},[C,w.state,F]),b.useEffect(()=>{(async()=>{if(null==j?void 0:j.com_contrat_client_id)try{const{data:e,error:t}=await u.from("com_param_type_facture").select("id, libelle").eq("com_contrat_client_id",j.com_contrat_client_id).eq("facture_exploitation",!0).single();if(t)return void console.error("Erreur lors de la récupération du type de facture exploitation:",t);e&&K({id:e.id,libelle:e.libelle})}catch(e){console.error("Erreur lors de la récupération du type de facture exploitation:",e)}})()},[null==j?void 0:j.com_contrat_client_id]);const W=e=>{const t={...e,id:Date.now().toString()};J(e=>[...e,t])},X=()=>{if(!q.entite)return;const e=F.find(e=>e.code===q.entite);return null==e?void 0:e.id},Y=[{name:"entite",label:"Entité",type:"select",options:F.map(e=>({id:e.id,code:e.code,libelle:e.libelle})),isEntityOption:!0,requireSelection:!0},{name:"dateDebut",label:"Date de début",type:"date",width:"160px"},{name:"dateFin",label:"Date de fin",type:"date",width:"160px"}],Z=[{label:"N° Document",accessor:"num_document",sortable:!0,render:e=>e||"-"},{label:"Date",accessor:"date_facture",sortable:!0,render:e=>y(new Date(e),"dd/MM/yyyy",{locale:f})},{label:"Entité",accessor:"entite",render:e=>`${e.code} - ${e.libelle}`},{label:"Tiers",accessor:"tiers",render:e=>`${e.code} - ${e.nom}`},{label:"Mode Paiement",accessor:"mode_paiement",render:e=>`${e.code} - ${e.libelle}`},{label:"Montant HT",accessor:"montant_ht",align:"right",render:e=>`${Number(e).toFixed(2)} €`},{label:"Montant TVA",accessor:"montant_tva",align:"right",render:e=>e?`${Number(e).toFixed(2)} €`:"-"},{label:"Montant TTC",accessor:"montant_ttc",align:"right",render:e=>`${Number(e).toFixed(2)} €`},{label:"PJ",accessor:"lien_piece_jointe",align:"center",width:"60px",render:e=>e?a.jsx("button",{onClick:async t=>{t.stopPropagation();try{const{data:t,error:r}=await u.storage.from("factures-achat").createSignedUrl(e,60);if(r)throw r;window.open(t.signedUrl,"_blank")}catch(r){console.error("Erreur lors de la génération de l'URL signée:",r),alert("Erreur lors de l'accès à la pièce jointe")}},className:"inline-flex items-center justify-center w-8 h-8 rounded-full hover:bg-blue-100 transition-colors cursor-pointer",title:"Ouvrir la pièce jointe",children:a.jsx(m,{size:18,className:"text-blue-600"})}):null},{label:"Date de création",accessor:"created_at",render:e=>y(new Date(e),"dd/MM/yyyy HH:mm",{locale:f})}],ee=[{label:"Éditer",icon:"edit",color:"var(--color-primary)",onClick:e=>{B(e.id),L(!0)}},{label:"Supprimer",icon:"delete",color:"#ef4444",onClick:async e=>{if(window.confirm(`Êtes-vous sûr de vouloir supprimer la facture ${e.num_document||"sans numéro"} ?`))try{const{error:t}=await u.from("fin_facture_achat").delete().eq("id",e.id);if(t)throw t;await Q(),W({label:"La facture a été supprimée avec succès",icon:"Check",color:"#22c55e"})}catch(t){console.error("Erreur lors de la suppression:",t),W({label:"Erreur lors de la suppression de la facture",icon:"AlertTriangle",color:"#ef4444"})}}}];return a.jsx("div",{className:n.container,children:a.jsxs(i,{title:I||S?"Chargement...":"Mes Factures",description:"Consultez et gérez vos factures d'achat",className:n.header,children:[a.jsxs("div",{className:"mb-6",children:[a.jsxs("div",{className:"flex items-end gap-4",children:[a.jsx(l,{filters:Y,values:q,onChange:e=>{A(e);try{localStorage.setItem("facturesFilters",JSON.stringify(e))}catch(t){console.error("Erreur lors de la sauvegarde des filtres:",t)}},requireSelection:!0,className:"flex-1 flex items-end gap-4"}),a.jsx(c,{label:k?"Recherche en cours...":"Afficher les Factures",icon:"Search",color:"var(--color-primary)",onClick:()=>{if(!(new Date(q.dateDebut)>new Date(q.dateFin)&&(W({label:"La date de début doit être antérieure à la date de fin",icon:"AlertTriangle",color:"#f59e0b"}),1)))if(q.entite){Q();try{localStorage.setItem("facturesFilters",JSON.stringify(q))}catch(e){console.error("Erreur lors de la sauvegarde des filtres:",e)}}else W({label:"Veuillez sélectionner une entité avant de rechercher",icon:"AlertTriangle",color:"#f59e0b"})},disabled:k||!q.entite})]}),a.jsx("div",{className:"mt-2 text-sm text-gray-600",children:R&&N.length>0?a.jsxs("span",{children:[M.length," facture(s) trouvée(s)"]}):R?a.jsx("span",{children:"Aucune facture trouvée"}):a.jsx("span",{children:'Utilisez les filtres ci-dessus et cliquez sur "Afficher les Factures"'})})]}),a.jsx("div",{className:"mb-6",children:a.jsx(c,{label:"Nouvelle facture",icon:"Plus",color:"var(--color-primary)",onClick:()=>{X()?(B(void 0),L(!0)):W({label:"Veuillez sélectionner une entité avant de créer une facture",icon:"AlertTriangle",color:"#f59e0b"})},disabled:!q.entite})}),I&&!R?a.jsx("div",{className:"flex justify-center items-center h-64",children:a.jsx("p",{className:"text-gray-500",children:"Chargement des factures..."})}):R?a.jsx(s,{columns:Z,data:M,actions:ee,defaultRowsPerPage:10,emptyTitle:"Aucune facture",emptyMessage:"Aucune facture d'achat n'a été créée pour le moment."}):a.jsx("div",{className:"flex justify-center items-center h-64 bg-gray-50 rounded-lg border border-gray-200",children:a.jsxs("div",{className:"text-center p-6",children:[a.jsx("p",{className:"text-gray-500 mb-2",children:'Sélectionnez une entité et cliquez sur "Afficher les Factures"'}),a.jsx("p",{className:"text-gray-400 text-sm",children:"Aucune recherche n'a encore été effectuée"})]})}),a.jsx(o,{toasts:P,onClose:e=>{J(t=>t.filter(t=>t.id!==e))}}),a.jsx(d,{isOpen:H,onClose:()=>L(!1),exploitationTypeFacture:G,onSaveSuccess:e=>{console.log("handleEditFactureSuccess appelé avec factureId:",e),Q(),W({label:`Facture ${V?"modifiée":"créée"} avec succès`,icon:"Check",color:"#22c55e"})},entiteId:X(),factureId:V})]})})};export{x as default};
