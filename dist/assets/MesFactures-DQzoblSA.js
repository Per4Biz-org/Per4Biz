import{u as ce,a as ne,b as oe,c as ie,r as n,f as u,e as q,s as A,d as P,j as r,g as O,P as le,F as de,B as k,D as ue,T as fe,E as me,h,i as z,k as he}from"./index-BA4fVXD-.js";const ge=()=>{const{setMenuItems:F}=ce(),{profil:s,loading:g}=ne();oe();const y=ie(),[L,S]=n.useState([]),[f,E]=n.useState([]),[v,R]=n.useState([]),[j,J]=n.useState(!1),[a,w]=n.useState(()=>{const e=localStorage.getItem("facturesFilters");if(e)try{const t=JSON.parse(e);return t.entite="",t}catch(t){return console.error("Erreur lors du parsing des filtres sauvegardés:",t),{entite:"",dateDebut:u(A(P(new Date)),"yyyy-MM-dd"),dateFin:u(q(new Date),"yyyy-MM-dd")}}return{entite:"",dateDebut:u(A(P(new Date)),"yyyy-MM-dd"),dateFin:u(q(new Date),"yyyy-MM-dd")}}),[b,M]=n.useState(!0),[_,D]=n.useState(!1),[U,N]=n.useState([]),[p,T]=n.useState(!1),[H,x]=n.useState(!1),[I,C]=n.useState(void 0),[V,B]=n.useState(null),m=async()=>{D(!0);try{if(!(s!=null&&s.com_contrat_client_id)){S([]),T(!0);return}let e=h.from("fin_facture_achat").select(`
          *,
          entite:id_entite (
            code,
            libelle
          ),
          tiers:id_tiers (
            code,
            nom
          ),
          mode_paiement:id_mode_paiement (
            code,
            libelle
          )`).eq("com_contrat_client_id",s.com_contrat_client_id);if(a.entite){const i=f.find(d=>d.code===a.entite||d.id===a.entite);i?(console.log(`Filtrage par entité: ${i.code} (ID: ${i.id})`),e=e.eq("id_entite",i.id)):console.warn(`Entité sélectionnée non trouvée dans la liste: ${a.entite}`)}a.dateDebut&&(e=e.gte("date_facture",a.dateDebut)),a.dateFin&&(e=e.lte("date_facture",a.dateFin)),e=e.order("date_facture",{ascending:!1});const{data:t,error:c}=await e;if(c)throw c;const o=t||[];console.log(`${o.length} factures récupérées avec les filtres actuels`),S(o),R(o),T(!0)}catch(e){console.error("Erreur lors de la récupération des factures:",e),l({label:"Erreur lors de la récupération des factures",icon:"AlertTriangle",color:"#ef4444"})}finally{M(!1),D(!1)}},G=async()=>{try{if(!(s!=null&&s.com_contrat_client_id)){E([]);return}const{data:e,error:t}=await h.from("com_entite").select("id, code, libelle").eq("com_contrat_client_id",s.com_contrat_client_id).eq("actif",!0).order("libelle");if(t)throw t;E(e||[]),J(!0)}catch(e){console.error("Erreur lors de la récupération des entités:",e)}};n.useEffect(()=>{F(menuItemsGestionFinanciere),g||(G(),M(!1))},[F,g,s==null?void 0:s.com_contrat_client_id]),n.useEffect(()=>{var e,t;if(j&&!b&&!_){const c=(e=y.state)==null?void 0:e.fromFactureEdit,o=(t=y.state)==null?void 0:t.entiteId;if(c)if(o){const i=f.find(d=>d.id===o);if(i){const d={...a,entite:i.code};w(d);try{localStorage.setItem("facturesFilters",JSON.stringify(d))}catch(se){console.error("Erreur lors de la sauvegarde des filtres:",se)}setTimeout(()=>{console.log("Recherche automatique après retour d'édition avec entité:",i.code),m()},100)}}else a.entite&&(console.log("Recherche automatique après retour d'édition avec filtre existant:",a.entite),m())}},[j,y.state,f]),n.useEffect(()=>{(async()=>{if(s!=null&&s.com_contrat_client_id)try{const{data:t,error:c}=await h.from("com_param_type_facture").select("id, libelle").eq("com_contrat_client_id",s.com_contrat_client_id).eq("facture_exploitation",!0).single();if(c){console.error("Erreur lors de la récupération du type de facture exploitation:",c);return}t&&B({id:t.id,libelle:t.libelle})}catch(t){console.error("Erreur lors de la récupération du type de facture exploitation:",t)}})()},[s==null?void 0:s.com_contrat_client_id]);const l=e=>{const t={...e,id:Date.now().toString()};N(c=>[...c,t])},K=e=>{N(t=>t.filter(c=>c.id!==e))},Q=e=>{C(e.id),x(!0)},W=async e=>{if(window.confirm(`Êtes-vous sûr de vouloir supprimer la facture ${e.num_document||"sans numéro"} ?`))try{const{error:t}=await h.from("fin_facture_achat").delete().eq("id",e.id);if(t)throw t;await m(),l({label:"La facture a été supprimée avec succès",icon:"Check",color:"#22c55e"})}catch(t){console.error("Erreur lors de la suppression:",t),l({label:"Erreur lors de la suppression de la facture",icon:"AlertTriangle",color:"#ef4444"})}},X=e=>{w(e);try{localStorage.setItem("facturesFilters",JSON.stringify(e))}catch(t){console.error("Erreur lors de la sauvegarde des filtres:",t)}},$=()=>{if(!a.entite)return;const e=f.find(t=>t.code===a.entite);return e==null?void 0:e.id},Y=()=>new Date(a.dateDebut)>new Date(a.dateFin)?(l({label:"La date de début doit être antérieure à la date de fin",icon:"AlertTriangle",color:"#f59e0b"}),!1):!0,Z=()=>{if(Y()){if(!a.entite){l({label:"Veuillez sélectionner une entité avant de rechercher",icon:"AlertTriangle",color:"#f59e0b"});return}m();try{localStorage.setItem("facturesFilters",JSON.stringify(a))}catch(e){console.error("Erreur lors de la sauvegarde des filtres:",e)}}},ee=e=>{console.log("handleEditFactureSuccess appelé avec factureId:",e),m(),l({label:`Facture ${I?"modifiée":"créée"} avec succès`,icon:"Check",color:"#22c55e"})},te=[{name:"entite",label:"Entité",type:"select",options:f.map(e=>({id:e.id,code:e.code,libelle:e.libelle})),isEntityOption:!0,requireSelection:!0},{name:"dateDebut",label:"Date de début",type:"date",width:"160px"},{name:"dateFin",label:"Date de fin",type:"date",width:"160px"}],re=[{label:"N° Document",accessor:"num_document",sortable:!0,render:e=>e||"-"},{label:"Date",accessor:"date_facture",sortable:!0,render:e=>u(new Date(e),"dd/MM/yyyy",{locale:z})},{label:"Entité",accessor:"entite",render:e=>`${e.code} - ${e.libelle}`},{label:"Tiers",accessor:"tiers",render:e=>`${e.code} - ${e.nom}`},{label:"Mode Paiement",accessor:"mode_paiement",render:e=>`${e.code} - ${e.libelle}`},{label:"Montant HT",accessor:"montant_ht",align:"right",render:e=>`${Number(e).toFixed(2)} €`},{label:"Montant TVA",accessor:"montant_tva",align:"right",render:e=>e?`${Number(e).toFixed(2)} €`:"-"},{label:"Montant TTC",accessor:"montant_ttc",align:"right",render:e=>`${Number(e).toFixed(2)} €`},{label:"PJ",accessor:"lien_piece_jointe",align:"center",width:"60px",render:e=>e?r.jsx("button",{onClick:async t=>{t.stopPropagation();try{const{data:c,error:o}=await h.storage.from("factures-achat").createSignedUrl(e,60);if(o)throw o;window.open(c.signedUrl,"_blank")}catch(c){console.error("Erreur lors de la génération de l'URL signée:",c),alert("Erreur lors de l'accès à la pièce jointe")}},className:"inline-flex items-center justify-center w-8 h-8 rounded-full hover:bg-blue-100 transition-colors cursor-pointer",title:"Ouvrir la pièce jointe",children:r.jsx(he,{size:18,className:"text-blue-600"})}):null},{label:"Date de création",accessor:"created_at",render:e=>u(new Date(e),"dd/MM/yyyy HH:mm",{locale:z})}],ae=[{label:"Éditer",icon:"edit",color:"var(--color-primary)",onClick:Q},{label:"Supprimer",icon:"delete",color:"#ef4444",onClick:W}];return r.jsx("div",{className:O.container,children:r.jsxs(le,{title:b||g?"Chargement...":"Mes Factures",description:"Consultez et gérez vos factures d'achat",className:O.header,children:[r.jsxs("div",{className:"mb-6",children:[r.jsxs("div",{className:"flex items-end gap-4",children:[r.jsx(de,{filters:te,values:a,onChange:X,requireSelection:!0,className:"flex-1 flex items-end gap-4"}),r.jsx(k,{label:_?"Recherche en cours...":"Afficher les Factures",icon:"Search",color:"var(--color-primary)",onClick:Z,disabled:_||!a.entite})]}),r.jsx("div",{className:"mt-2 text-sm text-gray-600",children:p&&L.length>0?r.jsxs("span",{children:[v.length," facture(s) trouvée(s)"]}):p?r.jsx("span",{children:"Aucune facture trouvée"}):r.jsx("span",{children:'Utilisez les filtres ci-dessus et cliquez sur "Afficher les Factures"'})})]}),r.jsx("div",{className:"mb-6",children:r.jsx(k,{label:"Nouvelle facture",icon:"Plus",color:"var(--color-primary)",onClick:()=>{$()?(C(void 0),x(!0)):l({label:"Veuillez sélectionner une entité avant de créer une facture",icon:"AlertTriangle",color:"#f59e0b"})},disabled:!a.entite})}),b&&!p?r.jsx("div",{className:"flex justify-center items-center h-64",children:r.jsx("p",{className:"text-gray-500",children:"Chargement des factures..."})}):p?r.jsx(ue,{columns:re,data:v,actions:ae,defaultRowsPerPage:10,emptyTitle:"Aucune facture",emptyMessage:"Aucune facture d'achat n'a été créée pour le moment."}):r.jsx("div",{className:"flex justify-center items-center h-64 bg-gray-50 rounded-lg border border-gray-200",children:r.jsxs("div",{className:"text-center p-6",children:[r.jsx("p",{className:"text-gray-500 mb-2",children:'Sélectionnez une entité et cliquez sur "Afficher les Factures"'}),r.jsx("p",{className:"text-gray-400 text-sm",children:"Aucune recherche n'a encore été effectuée"})]})}),r.jsx(fe,{toasts:U,onClose:K}),r.jsx(me,{isOpen:H,onClose:()=>x(!1),exploitationTypeFacture:V,onSaveSuccess:ee,entiteId:$(),factureId:I})]})})};export{ge as default};
