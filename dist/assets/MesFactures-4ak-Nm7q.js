import{u as e,a as t,b as a,m as r,j as n,P as s,s as i,c as o,d as c,F as l,B as d,D as u,T as m,E as f,f as g}from"./index-BO4bLl3H.js";import{u as b,b as p,r as y}from"./react-vendor-BFlg0-1N.js";import{f as h,e as v,s as _,g as x}from"./utils-vendor-CgmWFHjG.js";import"./supabase-vendor-fbgt7YPZ.js";const S=()=>{const{t:S}=e(),{setMenuItems:j}=t(),{profil:w,loading:D}=a();b();const E=p(),[N,F]=y.useState([]),[I,M]=y.useState([]),[C,A]=y.useState([]),[T,$]=y.useState(!1),[q,P]=y.useState(()=>{const e=localStorage.getItem("facturesFilters");if(e)try{const t=JSON.parse(e);return t.entite="",t}catch(t){return console.error("Erreur lors du parsing des filtres sauvegardés:",t),{entite:"",dateDebut:h(_(x(new Date)),"yyyy-MM-dd"),dateFin:h(v(new Date),"yyyy-MM-dd")}}return{entite:"",dateDebut:h(_(x(new Date)),"yyyy-MM-dd"),dateFin:h(v(new Date),"yyyy-MM-dd")}}),[k,O]=y.useState(!0),[B,R]=y.useState(!1),[J,z]=y.useState([]),[H,U]=y.useState(!1),[V,L]=y.useState(!1),[G,K]=y.useState(void 0),[Q,W]=y.useState(null),X=async()=>{R(!0);try{if(!(null==w?void 0:w.com_contrat_client_id))return F([]),void U(!0);let e=i.from("fin_facture_achat").select("\n          *,\n          entite:id_entite (\n            code,\n            libelle\n          ),\n          tiers:id_tiers (\n            code,\n            nom\n          ),\n          mode_paiement:id_mode_paiement (\n            code,\n            libelle\n          )").eq("com_contrat_client_id",w.com_contrat_client_id);if(q.entite){const t=I.find(e=>e.code===q.entite||e.id===q.entite);t?(console.log(`Filtrage par entité: ${t.code} (ID: ${t.id})`),e=e.eq("id_entite",t.id)):console.warn(`Entité sélectionnée non trouvée dans la liste: ${q.entite}`)}q.dateDebut&&(e=e.gte("date_facture",q.dateDebut)),q.dateFin&&(e=e.lte("date_facture",q.dateFin)),e=e.order("date_facture",{ascending:!1});const{data:t,error:a}=await e;if(a)throw a;const r=t||[];console.log(`${r.length} factures récupérées avec les filtres actuels`),F(r),A(r),U(!0)}catch(e){console.error("Erreur lors de la récupération des factures:",e),Y({label:S("messages.errorLoadingInvoices"),icon:"AlertTriangle",color:"#ef4444"})}finally{O(!1),R(!1)}};y.useEffect(()=>{j(r),D||((async()=>{try{if(!(null==w?void 0:w.com_contrat_client_id))return void M([]);const{data:e,error:t}=await i.from("com_entite").select("id, code, libelle").eq("com_contrat_client_id",w.com_contrat_client_id).eq("actif",!0).order("libelle");if(t)throw t;M(e||[]),$(!0)}catch(e){console.error("Erreur lors de la récupération des entités:",e)}})(),O(!1))},[j,D,null==w?void 0:w.com_contrat_client_id]),y.useEffect(()=>{var e,t;if(T&&!k&&!B){const r=null==(e=E.state)?void 0:e.fromFactureEdit,n=null==(t=E.state)?void 0:t.entiteId;if(r)if(n){const e=I.find(e=>e.id===n);if(e){const t={...q,entite:e.code};P(t);try{localStorage.setItem("facturesFilters",JSON.stringify(t))}catch(a){console.error("Erreur lors de la sauvegarde des filtres:",a)}setTimeout(()=>{console.log("Recherche automatique après retour d'édition avec entité:",e.code),X()},100)}}else q.entite&&(console.log("Recherche automatique après retour d'édition avec filtre existant:",q.entite),X())}},[T,E.state,I]),y.useEffect(()=>{(async()=>{if(null==w?void 0:w.com_contrat_client_id)try{const{data:e,error:t}=await i.from("com_param_type_facture").select("id, libelle").eq("com_contrat_client_id",w.com_contrat_client_id).eq("facture_exploitation",!0).single();if(t)return void console.error("Erreur lors de la récupération du type de facture exploitation:",t);e&&W({id:e.id,libelle:e.libelle})}catch(e){console.error("Erreur lors de la récupération du type de facture exploitation:",e)}})()},[null==w?void 0:w.com_contrat_client_id]);const Y=e=>{const t={...e,id:Date.now().toString()};z(e=>[...e,t])},Z=()=>{if(!q.entite)return;const e=I.find(e=>e.code===q.entite);return null==e?void 0:e.id},ee=[{name:"entite",label:S("forms.entity","Entité"),type:"select",options:I.map(e=>({id:e.id,code:e.code,libelle:e.libelle})),isEntityOption:!0,requireSelection:!0},{name:"dateDebut",label:S("forms.startDate","Date de début"),type:"date",width:"160px"},{name:"dateFin",label:S("forms.endDate","Date de fin"),type:"date",width:"160px"}],te=[{label:S("financial.documentNumber","N° Document"),accessor:"num_document",sortable:!0,render:e=>e||"-"},{label:S("financial.date","Date"),accessor:"date_facture",sortable:!0,render:e=>h(new Date(e),"dd/MM/yyyy",{locale:g})},{label:S("forms.entity","Entité"),accessor:"entite",render:e=>`${e.code} - ${e.libelle}`},{label:S("financial.thirdParty","Tiers"),accessor:"tiers",render:e=>`${e.code} - ${e.nom}`},{label:S("financial.paymentMode","Mode Paiement"),accessor:"mode_paiement",render:e=>`${e.code} - ${e.libelle}`},{label:S("financial.amountExVat","Montant HT"),accessor:"montant_ht",align:"right",render:e=>`${Number(e).toFixed(2)} €`},{label:S("financial.vatAmount","Montant TVA"),accessor:"montant_tva",align:"right",render:e=>e?`${Number(e).toFixed(2)} €`:"-"},{label:S("financial.amountIncVat","Montant TTC"),accessor:"montant_ttc",align:"right",render:e=>`${Number(e).toFixed(2)} €`},{label:S("invoices.attachment"),accessor:"lien_piece_jointe",align:"center",width:"60px",render:e=>e?n.jsx("button",{onClick:async t=>{t.stopPropagation();try{const{data:t,error:a}=await i.storage.from("factures-achat").createSignedUrl(e,60);if(a)throw a;window.open(t.signedUrl,"_blank")}catch(a){console.error("Erreur lors de la génération de l'URL signée:",a),alert(S("messages.errorAccessingAttachment","Erreur lors de l'accès à la pièce jointe"))}},className:"inline-flex items-center justify-center w-8 h-8 rounded-full hover:bg-blue-100 transition-colors cursor-pointer",title:S("messages.openAttachment"),children:n.jsx(s,{size:18,className:"text-blue-600"})}):null},{label:S("table.creationDate","Date de création"),accessor:"created_at",render:e=>h(new Date(e),"dd/MM/yyyy HH:mm",{locale:g})}],ae=[{label:S("table.edit","Éditer"),icon:"edit",color:"var(--color-primary)",onClick:e=>{K(e.id),L(!0)}},{label:S("table.delete","Supprimer"),icon:"delete",color:"#ef4444",onClick:async e=>{if(window.confirm(S("messages.confirmDeleteInvoice",{number:e.num_document||"sans numéro"})))try{const{error:t}=await i.from("fin_facture_achat").delete().eq("id",e.id);if(t)throw t;await X(),Y({label:S("messages.invoiceDeletedSuccess"),icon:"Check",color:"#22c55e"})}catch(t){console.error("Erreur lors de la suppression:",t),Y({label:S("messages.errorDeletingInvoice"),icon:"AlertTriangle",color:"#ef4444"})}}}];return n.jsx("div",{className:o.container,children:n.jsxs(c,{title:k||D?S("common.loading","Chargement..."):S("pages.finances.myInvoices","Mes Factures"),description:S("pages.finances.invoicesSubtitle","Consultez et gérez vos factures d'achat"),className:o.header,children:[n.jsxs("div",{className:"mb-6",children:[n.jsxs("div",{className:"flex items-end gap-4",children:[n.jsx(l,{filters:ee,values:q,onChange:e=>{P(e);try{localStorage.setItem("facturesFilters",JSON.stringify(e))}catch(t){console.error("Erreur lors de la sauvegarde des filtres:",t)}},requireSelection:!0,className:"flex-1 flex items-end gap-4"}),n.jsx(d,{label:B?S("table.searchInProgress","Recherche en cours..."):S("invoices.showInvoices"),icon:"Search",color:"var(--color-primary)",onClick:()=>{if(!(new Date(q.dateDebut)>new Date(q.dateFin)&&(Y({label:S("messages.startDateMustBeBeforeEndDate"),icon:"AlertTriangle",color:"#f59e0b"}),1)))if(q.entite){X();try{localStorage.setItem("facturesFilters",JSON.stringify(q))}catch(e){console.error("Erreur lors de la sauvegarde des filtres:",e)}}else Y({label:S("messages.selectEntityBeforeSearch"),icon:"AlertTriangle",color:"#f59e0b"})},disabled:B||!q.entite})]}),n.jsx("div",{className:"mt-2 text-sm text-gray-600",children:H&&N.length>0?n.jsx("span",{children:S("messages.invoicesFound",{count:C.length})}):H?n.jsx("span",{children:S("messages.noInvoicesFound")}):n.jsx("span",{children:S("messages.useFiltersAbove")})})]}),n.jsx("div",{className:"mb-6",children:n.jsx(d,{label:S("pages.finances.newInvoice","Nouvelle facture"),icon:"Plus",color:"var(--color-primary)",onClick:()=>{Z()?(K(void 0),L(!0)):Y({label:S("messages.selectEntityBeforeCreate"),icon:"AlertTriangle",color:"#f59e0b"})},disabled:!q.entite})}),k&&!H?n.jsx("div",{className:"flex justify-center items-center h-64",children:n.jsx("p",{className:"text-gray-500",children:S("messages.loadingInvoices")})}):H?n.jsx(u,{columns:te,data:C,actions:ae,defaultRowsPerPage:10,emptyTitle:S("messages.noInvoices","Aucune facture"),emptyMessage:S("messages.noInvoicesCreated","Aucune facture d'achat n'a été créée pour le moment.")}):n.jsx("div",{className:"flex justify-center items-center h-64 bg-gray-50 rounded-lg border border-gray-200",children:n.jsxs("div",{className:"text-center p-6",children:[n.jsx("p",{className:"text-gray-500 mb-2",children:S("messages.selectEntityAndSearch")}),n.jsx("p",{className:"text-gray-400 text-sm",children:S("messages.noSearchPerformed")})]})}),n.jsx(m,{toasts:J,onClose:e=>{z(t=>t.filter(t=>t.id!==e))}}),n.jsx(f,{isOpen:V,onClose:()=>L(!1),exploitationTypeFacture:Q,onSaveSuccess:e=>{console.log("handleEditFactureSuccess appelé avec factureId:",e),X(),Y({label:S("messages.invoiceSuccess",`Facture ${G?"modifiée":"créée"} avec succès`),icon:"Check",color:"#22c55e"})},entiteId:Z(),factureId:G})]})})};export{S as default};
